---
# Code-Server - VS Code in the browser

- name: Deploy Code-Server
  hosts: master
  tasks:
    - name: Create code-server namespace
      ansible.builtin.command: /usr/local/bin/k3s kubectl create namespace code-server --dry-run=client -o yaml
      register: ns_yaml
      changed_when: false

    - name: Apply code-server namespace
      ansible.builtin.shell: |
        echo '{{ ns_yaml.stdout }}' | /usr/local/bin/k3s kubectl apply -f -
      changed_when: true

    - name: Create code-server manifests
      ansible.builtin.copy:
        dest: /tmp/code-server.yaml
        mode: '0644'
        content: |
          ---
          # PVC for code-server config and workspace
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: code-server-config
            namespace: code-server
          spec:
            accessModes:
              - ReadWriteOnce
            storageClassName: rook-ceph-block
            resources:
              requests:
                storage: 10Gi
          ---
          # Secret for password
          apiVersion: v1
          kind: Secret
          metadata:
            name: code-server-secret
            namespace: code-server
          type: Opaque
          stringData:
            password: "changeme"
          ---
          # Deployment
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: code-server
            namespace: code-server
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: code-server
            template:
              metadata:
                labels:
                  app: code-server
              spec:
                containers:
                - name: code-server
                  image: lscr.io/linuxserver/code-server:latest
                  ports:
                  - containerPort: 8443
                  env:
                  - name: PUID
                    value: "1000"
                  - name: PGID
                    value: "1000"
                  - name: TZ
                    value: "America/New_York"
                  - name: PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: code-server-secret
                        key: password
                  - name: SUDO_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: code-server-secret
                        key: password
                  - name: DEFAULT_WORKSPACE
                    value: "/config/workspace"
                  volumeMounts:
                  - name: config
                    mountPath: /config
                  resources:
                    requests:
                      memory: "512Mi"
                      cpu: "500m"
                    limits:
                      memory: "2Gi"
                      cpu: "2000m"
                volumes:
                - name: config
                  persistentVolumeClaim:
                    claimName: code-server-config
          ---
          # Service with LoadBalancer
          apiVersion: v1
          kind: Service
          metadata:
            name: code-server
            namespace: code-server
          spec:
            type: LoadBalancer
            selector:
              app: code-server
            ports:
            - port: 8443
              targetPort: 8443

    - name: Deploy code-server
      ansible.builtin.command: /usr/local/bin/k3s kubectl apply -f /tmp/code-server.yaml
      changed_when: true

    - name: Wait for PVC to bind
      ansible.builtin.command: >
        /usr/local/bin/k3s kubectl -n code-server wait --for=jsonpath='{.status.phase}'=Bound pvc/code-server-config --timeout=120s
      changed_when: false
      retries: 3
      delay: 10
      register: result
      until: result.rc == 0

    - name: Wait for deployment to be ready
      ansible.builtin.command: >
        /usr/local/bin/k3s kubectl -n code-server wait --for=condition=Available deployment/code-server --timeout=300s
      changed_when: false
      retries: 3
      delay: 10
      register: result
      until: result.rc == 0

    - name: Get LoadBalancer IP
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl -n code-server get svc code-server -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
      register: lb_ip
      changed_when: false
      retries: 6
      delay: 5
      until: lb_ip.stdout != ""

    - name: Display access instructions
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Code-Server deployed!"
          - "=========================================="
          - ""
          - "Access VS Code in your browser at:"
          - "  http://{{ lb_ip.stdout }}:8443"
          - ""
          - "Password: changeme"
          - ""
          - "To change the password, edit the secret:"
          - "  kubectl -n code-server edit secret code-server-secret"
          - ""
          - "=========================================="
