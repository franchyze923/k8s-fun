---
# Code-Server - VS Code in the browser

- name: Deploy Code-Server
  hosts: master
  tasks:
    - name: Create code-server namespace
      ansible.builtin.command: "{{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} create namespace code-server --dry-run=client -o yaml"
      register: ns_yaml
      changed_when: false

    - name: Apply code-server namespace
      ansible.builtin.shell: |
        echo '{{ ns_yaml.stdout }}' | {{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} apply -f -
      changed_when: true

    - name: Create code-server manifests
      ansible.builtin.template:
        src: templates/code-server.yaml.j2
        dest: /tmp/code-server.yaml
        mode: '0644'

    - name: Deploy code-server
      ansible.builtin.command: "{{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} apply -f /tmp/code-server.yaml"
      changed_when: true

    - name: Wait for PVCs to bind
      ansible.builtin.shell: |
        {{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} -n code-server wait --for=jsonpath='{.status.phase}'=Bound pvc/code-server-config --timeout=120s
        {{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} -n code-server wait --for=jsonpath='{.status.phase}'=Bound pvc/shared-repos --timeout=120s
      changed_when: false
      retries: 3
      delay: 10
      register: result
      until: result.rc == 0
      when: install_ceph | default(false) | bool

    - name: Wait for deployment to be ready (includes init container for cloning repos)
      ansible.builtin.command: >
        {{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} -n code-server wait --for=condition=Available deployment/code-server --timeout=300s
      changed_when: false
      retries: 3
      delay: 10
      register: result
      until: result.rc == 0

    - name: Get LoadBalancer IP
      ansible.builtin.shell: |
        {{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} -n code-server get svc code-server -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
      register: lb_ip
      changed_when: false
      retries: 6
      delay: 5
      until: lb_ip.stdout != ""

    - name: Display access instructions
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Code-Server deployed!"
          - "=========================================="
          - ""
          - "Access VS Code in your browser at:"
          - "  http://{{ lb_ip.stdout }}:8443"
          - ""
          - "Password: changeme"
          - ""
          - "Default workspace: /repos"
          - "Sample repo: /repos/sample-app"
          - ""
          - "To change the password, edit the secret:"
          - "  kubectl -n code-server edit secret code-server-secret"
          - ""
          - "=========================================="
