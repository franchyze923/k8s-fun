---
# Rook-Ceph Installation Playbook

- name: Deploy Rook-Ceph
  hosts: master
  tasks:
    - name: Install git
      ansible.builtin.dnf:
        name: git
        state: present

    - name: Clone Rook repository
      ansible.builtin.git:
        repo: https://github.com/rook/rook.git
        dest: /tmp/rook
        version: v1.14.0
        single_branch: true
        depth: 1
        force: true

    - name: Deploy Rook CRDs
      ansible.builtin.command: /usr/local/bin/k3s kubectl apply -f /tmp/rook/deploy/examples/crds.yaml
      changed_when: true

    - name: Deploy Rook common resources
      ansible.builtin.command: /usr/local/bin/k3s kubectl apply -f /tmp/rook/deploy/examples/common.yaml
      changed_when: true

    - name: Deploy Rook operator
      ansible.builtin.command: /usr/local/bin/k3s kubectl apply -f /tmp/rook/deploy/examples/operator.yaml
      changed_when: true

    - name: Wait for Rook operator to be ready
      ansible.builtin.command: >
        /usr/local/bin/k3s kubectl -n rook-ceph wait
        --for=condition=Ready pod -l app=rook-ceph-operator
        --timeout=300s
      changed_when: false
      retries: 5
      delay: 30
      register: result
      until: result.rc == 0

    - name: Create Ceph cluster config
      ansible.builtin.copy:
        dest: /tmp/ceph-cluster.yaml
        content: |
          apiVersion: ceph.rook.io/v1
          kind: CephCluster
          metadata:
            name: rook-ceph
            namespace: rook-ceph
          spec:
            cephVersion:
              image: quay.io/ceph/ceph:v18.2.4
              allowUnsupported: false
            dataDirHostPath: /var/lib/rook
            skipUpgradeChecks: false
            continueUpgradeAfterChecksEvenIfNotHealthy: false
            mon:
              count: 3
              allowMultiplePerNode: true
            mgr:
              count: 2
              allowMultiplePerNode: true
              modules:
                - name: pg_autoscaler
                  enabled: true
            dashboard:
              enabled: true
              ssl: true
            monitoring:
              enabled: false
            crashCollector:
              disable: false
            cleanupPolicy:
              confirmation: ""
              sanitizeDisks:
                method: quick
                dataSource: zero
                iteration: 1
              allowUninstallWithVolumes: false
            placement:
              all:
                tolerations:
                  - operator: Exists
            storage:
              useAllNodes: true
              useAllDevices: true
              config:
                osdsPerDevice: "1"
        mode: '0644'

    - name: Deploy Ceph cluster
      ansible.builtin.command: /usr/local/bin/k3s kubectl apply -f /tmp/ceph-cluster.yaml
      changed_when: true

    - name: Wait for Ceph cluster to initialize (3-5 minutes)
      ansible.builtin.pause:
        minutes: 3
        prompt: "Waiting for Ceph cluster to initialize..."

    - name: Wait for Ceph mons to be ready
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl -n rook-ceph get pods -l app=rook-ceph-mon --no-headers | grep -c "Running" || echo "0"
      register: mon_count
      until: mon_count.stdout | int >= 1
      retries: 20
      delay: 15
      changed_when: false

    - name: Create CephBlockPool
      ansible.builtin.copy:
        dest: /tmp/ceph-blockpool.yaml
        content: |
          apiVersion: ceph.rook.io/v1
          kind: CephBlockPool
          metadata:
            name: replicapool
            namespace: rook-ceph
          spec:
            failureDomain: host
            replicated:
              size: 3
        mode: '0644'

    - name: Deploy CephBlockPool
      ansible.builtin.command: /usr/local/bin/k3s kubectl apply -f /tmp/ceph-blockpool.yaml
      changed_when: true

    - name: Create StorageClass
      ansible.builtin.copy:
        dest: /tmp/ceph-storageclass.yaml
        content: |
          apiVersion: storage.k8s.io/v1
          kind: StorageClass
          metadata:
            name: rook-ceph-block
            annotations:
              storageclass.kubernetes.io/is-default-class: "true"
          provisioner: rook-ceph.rbd.csi.ceph.com
          parameters:
            clusterID: rook-ceph
            pool: replicapool
            imageFormat: "2"
            imageFeatures: layering
            csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner
            csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph
            csi.storage.k8s.io/controller-expand-secret-name: rook-csi-rbd-provisioner
            csi.storage.k8s.io/controller-expand-secret-namespace: rook-ceph
            csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node
            csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph
            csi.storage.k8s.io/fstype: ext4
          reclaimPolicy: Delete
          allowVolumeExpansion: true
        mode: '0644'

    - name: Deploy StorageClass
      ansible.builtin.command: /usr/local/bin/k3s kubectl apply -f /tmp/ceph-storageclass.yaml
      changed_when: true

    - name: Get storage classes
      ansible.builtin.command: /usr/local/bin/k3s kubectl get sc
      changed_when: false
      register: sc_output

    - name: Display storage classes
      ansible.builtin.debug:
        msg: "{{ sc_output.stdout_lines }}"

    - name: Get Rook-Ceph pods
      ansible.builtin.command: /usr/local/bin/k3s kubectl -n rook-ceph get pods
      changed_when: false
      register: pods_output

    - name: Display Rook-Ceph pods
      ansible.builtin.debug:
        msg: "{{ pods_output.stdout_lines }}"
