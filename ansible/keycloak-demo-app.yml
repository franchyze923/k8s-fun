---
# Keycloak Demo App - Simple OIDC integration example

- name: Deploy Keycloak Demo App
  hosts: master
  tasks:
    - name: Create keycloak-demo-app manifests
      ansible.builtin.template:
        src: templates/keycloak-demo-app.yaml.j2
        dest: /tmp/keycloak-demo-app.yaml
        mode: '0644'

    - name: Deploy keycloak-demo-app
      ansible.builtin.command: "{{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} apply -f /tmp/keycloak-demo-app.yaml"
      changed_when: true

    - name: Wait for deployment to be ready
      ansible.builtin.command: >
        {{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} -n keycloak wait --for=condition=Available deployment/keycloak-demo-app --timeout=120s
      changed_when: false
      retries: 3
      delay: 5
      register: result
      until: result.rc == 0

    - name: Get LoadBalancer IP for demo app
      ansible.builtin.shell: |
        {{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} -n keycloak get svc keycloak-demo-app -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
      register: lb_ip
      changed_when: false
      retries: 6
      delay: 5
      until: lb_ip.stdout != ""

    - name: Get Keycloak LoadBalancer IP
      ansible.builtin.shell: |
        {{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} -n keycloak get svc keycloak -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
      register: keycloak_ip
      changed_when: false

    # --- Configure Keycloak: realm, client, test user ---

    - name: Wait for Keycloak to be fully ready
      ansible.builtin.uri:
        url: "http://{{ keycloak_ip.stdout }}:8080/realms/master"
        method: GET
        status_code: 200
      register: keycloak_ready
      retries: 30
      delay: 10
      until: keycloak_ready is not failed

    - name: Get Keycloak admin token
      ansible.builtin.uri:
        url: "http://{{ keycloak_ip.stdout }}:8080/realms/master/protocol/openid-connect/token"
        method: POST
        body_format: form-urlencoded
        body:
          client_id: admin-cli
          username: admin
          password: changeme
          grant_type: password
        status_code: 200
      register: admin_token

    - name: Check if demo realm exists
      ansible.builtin.uri:
        url: "http://{{ keycloak_ip.stdout }}:8080/admin/realms/demo"
        method: GET
        headers:
          Authorization: "Bearer {{ admin_token.json.access_token }}"
        status_code: [200, 404]
      register: realm_check

    - name: Create demo realm
      ansible.builtin.uri:
        url: "http://{{ keycloak_ip.stdout }}:8080/admin/realms"
        method: POST
        headers:
          Authorization: "Bearer {{ admin_token.json.access_token }}"
          Content-Type: application/json
        body_format: json
        body:
          realm: demo
          enabled: true
        status_code: 201
      when: realm_check.status == 404

    - name: Check if demo-app client exists
      ansible.builtin.uri:
        url: "http://{{ keycloak_ip.stdout }}:8080/admin/realms/demo/clients?clientId=demo-app"
        method: GET
        headers:
          Authorization: "Bearer {{ admin_token.json.access_token }}"
        status_code: 200
      register: client_check

    - name: Create demo-app client
      ansible.builtin.uri:
        url: "http://{{ keycloak_ip.stdout }}:8080/admin/realms/demo/clients"
        method: POST
        headers:
          Authorization: "Bearer {{ admin_token.json.access_token }}"
          Content-Type: application/json
        body_format: json
        body:
          clientId: demo-app
          enabled: true
          publicClient: true
          standardFlowEnabled: true
          directAccessGrantsEnabled: true
          rootUrl: "http://{{ lb_ip.stdout }}"
          redirectUris:
            - "http://{{ lb_ip.stdout }}/*"
          webOrigins:
            - "http://{{ lb_ip.stdout }}"
          protocol: openid-connect
        status_code: 201
      when: client_check.json | length == 0

    - name: Check if testuser exists
      ansible.builtin.uri:
        url: "http://{{ keycloak_ip.stdout }}:8080/admin/realms/demo/users?username=testuser&exact=true"
        method: GET
        headers:
          Authorization: "Bearer {{ admin_token.json.access_token }}"
        status_code: 200
      register: user_check

    - name: Create test user
      ansible.builtin.uri:
        url: "http://{{ keycloak_ip.stdout }}:8080/admin/realms/demo/users"
        method: POST
        headers:
          Authorization: "Bearer {{ admin_token.json.access_token }}"
          Content-Type: application/json
        body_format: json
        body:
          username: testuser
          enabled: true
          firstName: Test
          lastName: User
          email: testuser@example.com
          emailVerified: true
          credentials:
            - type: password
              value: testpass
              temporary: false
        status_code: 201
      when: user_check.json | length == 0

    - name: Display access instructions
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Keycloak Demo App deployed!"
          - "=========================================="
          - ""
          - "Demo App:  http://{{ lb_ip.stdout }}"
          - "Keycloak:  http://{{ keycloak_ip.stdout }}:8080/admin"
          - ""
          - "Realm, client, and test user auto-configured."
          - "Open the demo app, enter Keycloak URL:"
          - "  http://{{ keycloak_ip.stdout }}:8080"
          - ""
          - "Login with:  testuser / testpass"
          - ""
          - "=========================================="
