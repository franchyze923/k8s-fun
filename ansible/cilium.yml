---
# Cilium CNI Installation Playbook

- name: Deploy Cilium CNI
  hosts: master
  tasks:
    - name: Install Cilium CLI
      ansible.builtin.shell: |
        CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
        CLI_ARCH=amd64
        curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz
        tar xzvf cilium-linux-${CLI_ARCH}.tar.gz -C /usr/local/bin
        rm cilium-linux-${CLI_ARCH}.tar.gz
      args:
        creates: /usr/local/bin/cilium

    - name: Get API server endpoint
      ansible.builtin.set_fact:
        k8s_api_endpoint: "https://{{ ansible_host }}:6443"

    - name: Install Cilium with CNI settings
      ansible.builtin.shell: |
        export KUBECONFIG={{ kubeconfig_path }}
        /usr/local/bin/cilium install --version 1.16.0 \
          --set k8sServiceHost={{ ansible_host }} \
          --set k8sServicePort=6443 \
          --set operator.replicas=1 \
          {% if lb_implementation == 'cilium' %}--set l2announcements.enabled=true \
          --set externalIPs.enabled=true \
          {% endif %}--set k8sClientRateLimit.qps=50 \
          --set k8sClientRateLimit.burst=100 \
          {% if k8s_distro == 'kubeadm' %}--set kubeProxyReplacement=true{% endif %}
      register: cilium_install
      changed_when: "'Cilium was successfully installed' in cilium_install.stdout"
      failed_when: cilium_install.rc != 0 and 're-use a name' not in cilium_install.stderr and 'already installed' not in cilium_install.stderr

    - name: Wait for Cilium to be ready
      ansible.builtin.shell: |
        export KUBECONFIG={{ kubeconfig_path }}
        /usr/local/bin/cilium status --wait
      retries: 5
      delay: 30
      register: result
      until: result.rc == 0
      changed_when: false

    - name: Wait for all nodes to be Ready
      ansible.builtin.shell: |
        {{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} wait --for=condition=Ready node --all --timeout=300s
      changed_when: false
      retries: 5
      delay: 15
      register: result
      until: result.rc == 0

    - name: Get Cilium status
      ansible.builtin.shell: |
        export KUBECONFIG={{ kubeconfig_path }}
        /usr/local/bin/cilium status
      register: cilium_status
      changed_when: false

    - name: Display Cilium status
      ansible.builtin.debug:
        msg: "{{ cilium_status.stdout_lines }}"

    - name: Get cluster nodes
      ansible.builtin.shell: |
        {{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} get nodes -o wide
      changed_when: false
      register: nodes_output

    - name: Display cluster nodes
      ansible.builtin.debug:
        msg: "{{ nodes_output.stdout_lines }}"
