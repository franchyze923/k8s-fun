---
# kubeadm Cluster Installation Playbook
# Usage: ansible-playbook kubeadm.yml [-e k8s_version=1.30]

- name: Prepare all nodes
  vars:
    k8s_minor_version: "{{ k8s_version | default('1.35', true) }}"
  hosts: k8s_cluster
  gather_facts: false
  tasks:
    - name: Wait for SSH to be available
      ansible.builtin.wait_for_connection:
        timeout: 300
        delay: 10

    - name: Gather facts after SSH is ready
      ansible.builtin.setup:

    - name: Check if firewalld is installed
      ansible.builtin.command: systemctl list-unit-files firewalld.service
      register: firewalld_check
      changed_when: false
      failed_when: false

    - name: Disable firewalld
      ansible.builtin.systemd:
        name: firewalld
        state: stopped
        enabled: false
      when: firewalld_check.rc == 0 and 'firewalld.service' in firewalld_check.stdout

    - name: Wait for NTP sync
      ansible.builtin.shell: timedatectl show -p NTPSynchronized --value
      register: ntp_sync
      until: ntp_sync.stdout == "yes"
      retries: 30
      delay: 10
      changed_when: false

    - name: Wait for cloud-init to complete
      ansible.builtin.shell: cloud-init status | grep -qE 'done|error'
      register: cloud_init_result
      until: cloud_init_result.rc == 0
      retries: 60
      delay: 10
      changed_when: false

    - name: Create user fran with sudo access
      ansible.builtin.user:
        name: fran
        password: "{{ '248919' | password_hash('sha512') }}"
        groups: wheel
        append: true
        shell: /bin/bash

    - name: Enable password authentication for SSH
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication yes'
      notify: Restart sshd

    - name: Remove old Kubernetes repo if exists
      ansible.builtin.file:
        path: /etc/yum.repos.d/kubernetes.repo
        state: absent

    - name: Clean dnf cache
      ansible.builtin.command: dnf clean all
      changed_when: true

    - name: Disable swap
      ansible.builtin.command: swapoff -a
      changed_when: false

    - name: Remove swap from fstab
      ansible.builtin.lineinfile:
        path: /etc/fstab
        regexp: '.*swap.*'
        state: absent

    - name: Disable SELinux
      ansible.builtin.shell: |
        setenforce 0 || true
        sed -i 's/^SELINUX=enforcing/SELINUX=permissive/' /etc/selinux/config
      changed_when: true

    - name: Load required kernel modules config
      ansible.builtin.copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter
        mode: '0644'

    - name: Load kernel modules
      ansible.builtin.shell: |
        modprobe overlay
        modprobe br_netfilter
      changed_when: true

    - name: Set sysctl params for Kubernetes
      ansible.builtin.copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1
        mode: '0644'

    - name: Apply sysctl params
      ansible.builtin.command: sysctl --system
      changed_when: true

    - name: Add Docker CE repo (for containerd)
      ansible.builtin.shell: |
        dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
      args:
        creates: /etc/yum.repos.d/docker-ce.repo

    - name: Install nfs-utils (required for NFS PersistentVolumes)
      ansible.builtin.dnf:
        name: nfs-utils
        state: present

    - name: Install containerd
      ansible.builtin.dnf:
        name: containerd.io
        state: present

    - name: Generate default containerd config
      ansible.builtin.shell: |
        containerd config default > /etc/containerd/config.toml
      changed_when: true

    - name: Enable SystemdCgroup in containerd
      ansible.builtin.replace:
        path: /etc/containerd/config.toml
        regexp: 'SystemdCgroup = false'
        replace: 'SystemdCgroup = true'

    - name: Start and enable containerd
      ansible.builtin.systemd:
        name: containerd
        state: restarted
        enabled: true
        daemon_reload: true

    - name: Add Kubernetes repo
      ansible.builtin.copy:
        dest: /etc/yum.repos.d/kubernetes.repo
        mode: '0644'
        content: |
          [kubernetes]
          name=Kubernetes
          baseurl=https://pkgs.k8s.io/core:/stable:/v{{ k8s_minor_version }}/rpm/
          enabled=1
          gpgcheck=0
          sslverify=0

    - name: Refresh dnf cache for kubernetes repo
      ansible.builtin.command: dnf makecache --refresh
      changed_when: true

    - name: Install kubeadm, kubelet, kubectl
      ansible.builtin.dnf:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present

    - name: Enable and start kubelet
      ansible.builtin.systemd:
        name: kubelet
        state: started
        enabled: true

  handlers:
    - name: Restart sshd
      ansible.builtin.systemd:
        name: sshd
        state: restarted

- name: Initialize kubeadm master
  hosts: master
  tasks:
    - name: Check if kubeadm already initialized
      ansible.builtin.stat:
        path: /etc/kubernetes/admin.conf
      register: kubeadm_conf

    - name: Initialize kubeadm cluster
      ansible.builtin.command: >
        kubeadm init
        --pod-network-cidr=10.244.0.0/16
        --skip-phases=addon/kube-proxy
        --apiserver-advertise-address={{ ansible_host }}
      when: not kubeadm_conf.stat.exists
      register: kubeadm_init

    - name: Wait for API server to be ready
      ansible.builtin.command: kubectl --kubeconfig=/etc/kubernetes/admin.conf get nodes
      changed_when: false
      retries: 10
      delay: 5
      register: result
      until: result.rc == 0

    - name: Remove control-plane taint (allow scheduling on master)
      ansible.builtin.shell: |
        kubectl --kubeconfig=/etc/kubernetes/admin.conf taint nodes --all node-role.kubernetes.io/control-plane- || true
      changed_when: true

    - name: Generate join command
      ansible.builtin.command: kubeadm token create --print-join-command
      changed_when: false
      register: join_command

    - name: Set join command fact
      ansible.builtin.set_fact:
        kubeadm_join_command: "{{ join_command.stdout }}"

- name: Join worker nodes
  hosts: workers
  tasks:
    - name: Check if already joined
      ansible.builtin.stat:
        path: /etc/kubernetes/kubelet.conf
      register: kubelet_conf

    - name: Join cluster
      ansible.builtin.command: "{{ hostvars[groups['master'][0]]['kubeadm_join_command'] }}"
      when: not kubelet_conf.stat.exists

- name: Verify cluster and fetch kubeconfig
  hosts: master
  tasks:
    - name: Wait for all nodes to register (not Ready yet - needs CNI)
      ansible.builtin.shell: |
        kubectl --kubeconfig=/etc/kubernetes/admin.conf get nodes --no-headers | wc -l
      register: node_count
      until: node_count.stdout | int >= 3
      retries: 20
      delay: 10
      changed_when: false

    - name: Get cluster nodes
      ansible.builtin.command: kubectl --kubeconfig=/etc/kubernetes/admin.conf get nodes -o wide
      changed_when: false
      register: nodes_output

    - name: Display cluster nodes
      ansible.builtin.debug:
        msg: "{{ nodes_output.stdout_lines }}"

    - name: Setup kubeconfig for rocky user
      block:
        - name: Create .kube directory for rocky
          ansible.builtin.file:
            path: /home/rocky/.kube
            state: directory
            owner: rocky
            group: rocky
            mode: '0700'

        - name: Copy kubeconfig for rocky user
          ansible.builtin.copy:
            src: /etc/kubernetes/admin.conf
            dest: /home/rocky/.kube/config
            owner: rocky
            group: rocky
            mode: '0600'
            remote_src: true

    - name: Fetch kubeconfig
      ansible.builtin.fetch:
        src: /etc/kubernetes/admin.conf
        dest: ../kubeconfig
        flat: true

    - name: Update kubeconfig with master IP
      ansible.builtin.replace:
        path: ../kubeconfig
        regexp: 'server: https://[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:6443'
        replace: "server: https://{{ ansible_host }}:6443"
      delegate_to: localhost
      become: false
