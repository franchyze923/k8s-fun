---
# Keycloak - Identity and Access Management

- name: Deploy Keycloak
  hosts: master
  tasks:
    - name: Create keycloak namespace
      ansible.builtin.command: "{{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} create namespace keycloak --dry-run=client -o yaml"
      register: ns_yaml
      changed_when: false

    - name: Apply keycloak namespace
      ansible.builtin.shell: |
        echo '{{ ns_yaml.stdout }}' | {{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} apply -f -
      changed_when: true

    - name: Create keycloak manifests
      ansible.builtin.template:
        src: templates/keycloak.yaml.j2
        dest: /tmp/keycloak.yaml
        mode: '0644'

    - name: Deploy keycloak
      ansible.builtin.command: "{{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} apply -f /tmp/keycloak.yaml"
      changed_when: true

    - name: Wait for PVCs to bind
      ansible.builtin.shell: |
        {{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} -n keycloak wait --for=jsonpath='{.status.phase}'=Bound pvc/keycloak-data --timeout=120s
      changed_when: false
      retries: 3
      delay: 10
      register: result
      until: result.rc == 0
      when: install_ceph | default(false) | bool

    - name: Wait for deployment to be ready
      ansible.builtin.command: >
        {{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} -n keycloak wait --for=condition=Available deployment/keycloak --timeout=300s
      changed_when: false
      retries: 3
      delay: 10
      register: result
      until: result.rc == 0

    - name: Get LoadBalancer IP
      ansible.builtin.shell: |
        {{ kubectl_bin }} --kubeconfig={{ kubeconfig_path }} -n keycloak get svc keycloak -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
      register: lb_ip
      changed_when: false
      retries: 6
      delay: 5
      until: lb_ip.stdout != ""

    - name: Save credentials to local file
      ansible.builtin.copy:
        content: |
          Keycloak URL: http://{{ lb_ip.stdout }}:8080
          Admin Console: http://{{ lb_ip.stdout }}:8080/admin
          Username: admin
          Password: changeme
        dest: "{{ playbook_dir }}/../keycloak-credentials.txt"
        mode: '0600'
      delegate_to: localhost
      become: false

    - name: Display access instructions
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Keycloak deployed!"
          - "=========================================="
          - ""
          - "Access Keycloak at:"
          - "  http://{{ lb_ip.stdout }}:8080"
          - ""
          - "Admin Console:"
          - "  http://{{ lb_ip.stdout }}:8080/admin"
          - ""
          - "Username: admin"
          - "Password: changeme"
          - ""
          - "Credentials saved to: keycloak-credentials.txt"
          - ""
          - "=========================================="
